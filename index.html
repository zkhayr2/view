<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Senarai RSVP</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // 🔹 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAyXoBcnGabIuKSaCjso_hA5CsCDqKnNek",
      authDomain: "wedding-guestbook-2086a.firebaseapp.com",
      projectId: "wedding-guestbook-2086a",
      storageBucket: "wedding-guestbook-2086a.firebasestorage.app",
      messagingSenderId: "54243617499",
      appId: "1:54243617499:web:bde886a3be0540492dfafe",
      measurementId: "G-CW3N7JZ6NT"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🔍 Search function
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('#rsvp-table-body tr');

        rows.forEach(row => {
          let nameCell = row.cells[1].textContent.toLowerCase(); // column Nama
          if (nameCell.indexOf(filter) > -1) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      });
    });

    // 🔹 Listen RSVP data
    function listenRSVPs() {
      const rsvpsRef = collection(db, "rsvps");
      const q = query(rsvpsRef, orderBy("name", "asc"));

      onSnapshot(q, (snapshot) => {
        let totalRSVP = 0;
        let totalActual = 0;
        let tableRows = "";
        let index = 1;

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          const name = data.name || "-";
          const attending = data.attending || "no";
          const pax = data.pax || 0;
          const note = data.note || "";
          const checked = data.checked ? "checked" : "";
          const actualPax = data.actualPax || ""; // field baru

          if (attending === "yes") {
            totalRSVP += pax;
          }
          if (data.actualPax) {
            totalActual += Number(data.actualPax);
          }

          tableRows += `
            <tr>
              <td style="text-align:center;">${index++}</td>
              <td>${name}</td>
              <td style="text-align:center;">${attending}</td>
              <td style="text-align:center;">${pax}</td>
              <td>${note}</td>
              <td style="text-align:center; display:none;">
                <input type="checkbox" ${attending === "yes" ? "checked" : ""} disabled>
              </td>
              <td style="text-align:center;">
                <input type="checkbox" class="checkBox" data-id="${id}" ${checked}>
              </td>
              <td style="text-align:center;">
                <input type="number" min="0" class="actualPaxInput" data-id="${id}" value="${actualPax}" style="width:60px; text-align:center;">
              </td>
            </tr>
          `;
        });

        document.getElementById("rsvp-table-body").innerHTML = tableRows;
        document.getElementById("total-rsvp").innerText = totalRSVP;
        document.getElementById("total-actual").innerText = totalActual;

        // 🔹 Checkbox update
        document.querySelectorAll(".checkBox").forEach(cb => {
          cb.addEventListener("change", async function() {
            const docId = this.getAttribute("data-id");
            const docRef = doc(db, "rsvps", docId);

            await updateDoc(docRef, {
              checked: this.checked
            });
          });
        });

        // 🔹 Actual Pax input update
        document.querySelectorAll(".actualPaxInput").forEach(input => {
          input.addEventListener("change", async function() {
            const docId = this.getAttribute("data-id");
            const docRef = doc(db, "rsvps", docId);
            const val = this.value ? Number(this.value) : 0;

            await updateDoc(docRef, {
              actualPax: val
            });
          });
        });
      });
    }

    listenRSVPs();
  </script>
</head>
<body style="font-family: Times New Roman, sans-serif; text-align:center; padding:20px;">
<img src="https://zkhayr2.github.io/view/asset/12.webp" alt="AZ Logo" width="80">
  <h1>Senarai RSVP</h1>

 
  <!-- Jumlah -->
 <div style="display:flex; justify-content:center; gap:40px; margin:15px 0;">
  <h4>Jumlah Pax RSVP: <span id="total-rsvp">0</span></h4>
  <h4>Jumlah Sebenar Hadir: <span id="total-actual">0</span></h4>
</div>

  <!-- Table -->
  <table border="1" cellpadding="10" cellspacing="0" style="margin:auto; border-collapse: collapse; width:95%;">
    <thead style="background:#f2f2f2;">
       <!-- Search bar -->
       <div style="text-align:right; margin-bottom:10px;">
  <input type="text" id="searchInput" placeholder="Search name" 
         style="padding:5px; width:200px;">
</div>
      <tr>
        <th style="text-align:center;">Bil.</th>
        <th style="text-align:left;">Nama</th>
        <th style="text-align:center;">Kehadiran</th>
        <th style="text-align:center;">Pax (RSVP)</th>
        <th style="text-align:left;">Ucapan/Nota</th>
        <th style="text-align:center; display:none">Tick Hadir</th>
        <th style="text-align:center;">Check(/)</th>
        <th style="text-align:center;">Actual Pax</th>
      </tr>
    </thead>
    <tbody id="rsvp-table-body">
      <!-- Data akan muncul sini -->
    </tbody>
  </table>

</body>
</html>
